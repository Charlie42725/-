// ======================================
// ä¸€ç•ªè³žç¶²ç«™ Prisma Schema (for Neon)
// Database: PostgreSQL (Neon)
// Author: FuturiX Dev
// ======================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")       // <- Neon Connection Pooler
  directUrl = env("DIRECT_URL")        // <- ç”¨æ–¼ migrations å’Œ Prisma Studio
}

// -----------------------------
// ðŸ”¹ è¼ªæ’­ Banner
// -----------------------------
model Banner {
  id              Int      @id @default(autoincrement())
  title           String
  subtitle        String   @default("")
  description     String   @default("")
  imageUrl        String
  imagePositionX  Int      @default(50)   // åœ–ç‰‡ç„¦é»ž X è»¸ (0-100%)
  imagePositionY  Int      @default(50)   // åœ–ç‰‡ç„¦é»ž Y è»¸ (0-100%)
  linkUrl         String   @default("")
  sortOrder       Int      @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// -----------------------------
// ðŸ”¹ å“ç‰Œ / IP
// -----------------------------
model Brand {
  id          Int       @id @default(autoincrement())
  name        String
  slug        String    @unique
  description String?
  logoUrl     String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]
}

// -----------------------------
// ðŸ”¹ å•†å“
// -----------------------------
model Product {
  id               Int             @id @default(autoincrement())
  brand            Brand           @relation(fields: [brandId], references: [id], onDelete: Cascade)
  brandId          Int
  name             String
  slug             String
  shortDescription String?
  longDescription  String?
  price            Int
  totalTickets     Int             @default(0)
  soldTickets      Int             @default(0)
  status           ProductStatus   @default(draft)
  coverImage       String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  variants         ProductVariant[]
  discounts        ProductDiscount[]
  images           Image[]
  logs             ProductLog[]
  lotteryDraws     LotteryDraw[]
  drawQueues       DrawQueue[]

  @@unique([brandId, slug])
  @@index([slug])
  @@index([status])
  @@index([brandId])
}

// -----------------------------
// ðŸ”¹ å•†å“çŽé … / ç‰ˆæœ¬
// -----------------------------
model ProductVariant {
  id           Int           @id @default(autoincrement())
  product      Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId    Int
  prize        String        // è³žç­‰ (Aè³žã€Bè³žã€Cè³žã€Lastè³žç­‰)
  name         String        // çŽé …åç¨± (ç‰¹ç­‰çŽå…¬ä»”ã€é™å®šæµ·å ±ç­‰)
  rarity       String?       // ç¨€æœ‰åº¦ (SSR/SR/R/N)
  value        Int           @default(3000)  // çŽé …åƒ¹å€¼ (é è¨­ 3000)
  stock        Int           @default(0)
  imageUrl     String?
  isActive     Boolean       @default(true)
  isLastPrize  Boolean       @default(false)  // æ¨™è¨˜ç‚º Last è³ž
  probability  Float?        // è‡ªå®šç¾©æŠ½ä¸­æ©ŸçŽ‡ (0-1)
  createdAt    DateTime      @default(now())

  lotteryDraws LotteryDraw[]

  @@index([productId])
}

// -----------------------------
// ðŸ”¹ åœ–ç‰‡åº«
// -----------------------------
model Image {
  id         Int       @id @default(autoincrement())
  product    Product?  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId  Int?
  url        String
  type       ImageType @default(gallery)
  sortOrder  Int       @default(0)
  createdAt  DateTime  @default(now())
}

// -----------------------------
// ðŸ”¹ æœƒå“¡ç”¨æˆ¶
// -----------------------------
model User {
  id                Int       @id @default(autoincrement())
  email             String    @unique
  passwordHash      String
  nickname          String
  gender            Gender?
  phone             String?   @unique
  points            Int       @default(0)  // é»žæ•¸é¤˜é¡
  role              UserRole  @default(user)  // ç”¨æˆ¶è§’è‰²
  isEmailVerified   Boolean   @default(false)
  isPhoneVerified   Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  orders            Order[]
  pointTransactions PointTransaction[]
  lotteryDraws      LotteryDraw[]
  prizeRedemptions  PrizeRedemption[]
  drawQueues        DrawQueue[]

  @@index([email])
  @@index([phone])
}

// -----------------------------
// ðŸ”¹ é©—è­‰ç¢¼è¨˜éŒ„
// -----------------------------
model VerificationCode {
  id         Int       @id @default(autoincrement())
  type       CodeType  // email æˆ– phone
  target     String    // email åœ°å€æˆ–æ‰‹æ©Ÿè™Ÿç¢¼
  code       String    // é©—è­‰ç¢¼
  expiresAt  DateTime  // éŽæœŸæ™‚é–“
  isUsed     Boolean   @default(false)
  createdAt  DateTime  @default(now())

  @@index([target, type, isUsed])
}

// -----------------------------
// ðŸ”¹ å¾Œå°ç®¡ç†å“¡
// -----------------------------
model AdminUser {
  id            Int        @id @default(autoincrement())
  username      String     @unique
  passwordHash  String
  role          AdminRole  @default(editor)
  createdAt     DateTime   @default(now())

  logs          ProductLog[]
}

// -----------------------------
// ðŸ”¹ å•†å“æ“ä½œç´€éŒ„ (ä¸Šæž¶ / ä¸‹æž¶ / æ›´æ–°)
// -----------------------------
model ProductLog {
  id         Int         @id @default(autoincrement())
  product    Product?    @relation(fields: [productId], references: [id], onDelete: SetNull)
  productId  Int?
  admin      AdminUser?  @relation(fields: [adminId], references: [id], onDelete: SetNull)
  adminId    Int?
  action     String
  message    String?
  createdAt  DateTime    @default(now())
}

// -----------------------------
// ðŸ”¹ è¨‚å–®
// -----------------------------
model Order {
  id              Int          @id @default(autoincrement())
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          Int
  orderNumber     String       @unique  // è¨‚å–®ç·¨è™Ÿ
  packageName     String       // æ–¹æ¡ˆåç¨±
  basePoints      Int          // åŸºç¤Žé»žæ•¸
  bonusPoints     Int          // è´ˆé€é»žæ•¸
  totalPoints     Int          // ç¸½é»žæ•¸
  amount          Int          // æ”¯ä»˜é‡‘é¡
  status          OrderStatus  @default(pending)
  paymentMethod   String?      // ä»˜æ¬¾æ–¹å¼
  paymentInfo     String?      // ä»˜æ¬¾è³‡è¨Š (JSON)
  paidAt          DateTime?    // ä»˜æ¬¾æ™‚é–“
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
}

// -----------------------------
// ðŸ”¹ é»žæ•¸ç•°å‹•ç´€éŒ„
// -----------------------------
model PointTransaction {
  id            Int                    @id @default(autoincrement())
  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        Int
  type          PointTransactionType   // ç•°å‹•é¡žåž‹
  amount        Int                    // ç•°å‹•é»žæ•¸ (æ­£æ•¸ç‚ºå¢žåŠ ï¼Œè² æ•¸ç‚ºæ‰£é™¤)
  balance       Int                    // ç•°å‹•å¾Œé¤˜é¡
  description   String                 // ç•°å‹•èªªæ˜Ž
  relatedId     String?                // ç›¸é—œè¨‚å–®/æ´»å‹• ID
  createdAt     DateTime               @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// -----------------------------
// ðŸ”¹ æŠ½çŽè¨˜éŒ„
// -----------------------------
model LotteryDraw {
  id              Int              @id @default(autoincrement())
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          Int
  product         Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId       Int
  variant         ProductVariant   @relation(fields: [variantId], references: [id], onDelete: Cascade)
  variantId       Int
  ticketNumber    Int              // æŠ½åˆ°çš„è™Ÿç¢¼
  pointsUsed      Int              // æ¶ˆè€—çš„é»žæ•¸
  triggeredPity   Boolean          @default(false)  // æ˜¯å¦è§¸ç™¼ä¿åº•
  isLastPrize     Boolean          @default(false)  // æ˜¯å¦ç‚º Last è³ž
  isRedeemed      Boolean          @default(false)  // æ˜¯å¦å·²å…Œæ›æˆé»žæ•¸
  createdAt       DateTime         @default(now())

  redemption      PrizeRedemption?

  @@index([userId])
  @@index([productId])
  @@index([variantId])
  @@index([createdAt])
  @@index([isRedeemed])
  @@index([userId, isRedeemed])  // è¤‡åˆç´¢å¼•ï¼šåŠ é€Ÿ prizes API æŸ¥è©¢
  @@unique([productId, ticketNumber]) // æ¯å€‹å•†å“çš„æ¯å€‹è™Ÿç¢¼åªèƒ½è¢«æŠ½ä¸€æ¬¡
}

// -----------------------------
// ðŸ”¹ çŽå“å…Œæ›è¨˜éŒ„
// -----------------------------
model PrizeRedemption {
  id              Int          @id @default(autoincrement())
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          Int
  lotteryDraw     LotteryDraw  @relation(fields: [lotteryDrawId], references: [id], onDelete: Cascade)
  lotteryDrawId   Int          @unique
  prizeValue      Int          // çŽå“åŽŸå§‹åƒ¹å€¼
  pointsReceived  Int          // å¯¦éš›ç²å¾—é»žæ•¸
  createdAt       DateTime     @default(now())

  @@index([userId])
  @@index([createdAt])
}

// -----------------------------
// ðŸ”¸ ENUM å®šç¾©
// -----------------------------
enum ProductStatus {
  draft
  active
  sold_out
  archived
}

enum ImageType {
  cover
  gallery
  variant
}

enum AdminRole {
  admin
  editor
}

enum Gender {
  male
  female
  other
}

enum UserRole {
  user
  admin
}

enum CodeType {
  email
  phone
}

enum OrderStatus {
  pending       // å¾…ä»˜æ¬¾
  paid          // å·²ä»˜æ¬¾
  completed     // å·²å®Œæˆ
  cancelled     // å·²å–æ¶ˆ
  failed        // å¤±æ•—
}

enum DiscountType {
  full_set   // é–‹å¥—å„ªæƒ 
  combo      // çµ„åˆåƒ¹å„ªæƒ 
}

enum PointTransactionType {
  purchase      // è³¼è²·
  bonus         // è´ˆé€
  lottery       // æŠ½çŽæ¶ˆè€—
  refund        // é€€æ¬¾
  redemption    // çŽå“å…Œæ›
  admin_adjust  // ç®¡ç†å“¡èª¿æ•´
}

// -----------------------------
// ðŸ”¹ å•†å“æŠ˜æ‰£æ–¹æ¡ˆ
// -----------------------------
model ProductDiscount {
  id         Int          @id @default(autoincrement())
  product    Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId  Int
  type       DiscountType
  drawCount  Int          // æŠ½æ•¸é–€æª»
  price      Int          // è©²æ–¹æ¡ˆç¸½åƒ¹ï¼ˆé»žæ•¸ï¼‰
  label      String?      // é¡¯ç¤ºåç¨±ï¼ˆå¦‚ã€ŒåŠå¥—å„ªæƒ ã€ï¼‰
  isActive   Boolean      @default(true)
  createdAt  DateTime     @default(now())

  @@index([productId, type])
  @@unique([productId, type, drawCount])
}

// -----------------------------
// ðŸ”¹ æŽ’éšŠç‹€æ…‹
// -----------------------------
enum QueueStatus {
  waiting
  active
  completed
  expired
  left
}

// -----------------------------
// ðŸ”¹ æŠ½è³žæŽ’éšŠ
// -----------------------------
model DrawQueue {
  id            Int          @id @default(autoincrement())
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        Int
  product       Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId     Int
  status        QueueStatus  @default(waiting)
  position      Int          // æŽ’éšŠé †åºï¼ˆéžå¢žï¼Œç”¨æ–¼æŽ’åºï¼‰
  joinedAt      DateTime     @default(now())
  activatedAt   DateTime?    // è¼ªåˆ°æ™‚çš„æ™‚é–“
  expiresAt     DateTime?    // activatedAt + 3 åˆ†é˜
  completedAt   DateTime?    // å®Œæˆæˆ–é›¢é–‹æ™‚é–“
  lastHeartbeat DateTime     @default(now())

  @@index([productId, status])
  @@index([productId, position])
  @@index([userId])
  @@index([expiresAt])
}
